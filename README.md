A Jenkins plugin to send Pipeline build logs to [Amazon CloudWatch Logs](https://docs.aws.amazon.com/AmazonCloudWatch/latest/logs/WhatIsCloudWatchLogs.html)
and display them directly from the same source.

This is the [reference implementation of JEP-210](https://github.com/jenkinsci/jep/blob/master/jep/210/README.adoc#prototype-implementation).

# Usage

After installing, go to **Manage Jenkins Â» AWS** and configure your **Log group**.
You may also need to configure your **Amazon Credentials**, depending on how Jenkins is running.
Be sure to click **Validate configuration** before saving.

Henceforth, so long as the plugin remains enabled, all Pipeline builds will stream log content directly to CloudWatch Logs.
Viewing the **Console** link in Jenkins (or the equivalent in Blue Ocean) will load log content directly from CloudWatch Logs.

The first line of a (classic) console view will be a link to the CloudWatch Logs section of the AWS Console
with the log stream name for all messages coming from the Jenkins master and a filter predefined to show that build.
(Currently you would need to manually browse to related log streams to see output produced by agents.)

## Security

With this plugin active, log content generated by processes running on agents, such as `sh` steps,
will be sent to CloudWatch Logs directly from that agent machine, without passing through the Jenkins master.
For that to work, the master will send AWS credentials to the agent sufficient to write logs.
That prevents a rogue build from writing to logs of another job (though not another build of the same job),
or otherwise causing problems.

It will attempt to use either the `AssumeRole` or `GetFederationToken` API calls to create a fresh session token
with a policy restriction allowing the agent only to write logs to the streams for this job and nothing else.
One of these is selected by inspecting the configured master credentials according to
[this table](https://docs.aws.amazon.com/IAM/latest/UserGuide/id_credentials_temp_request.html#stsapi_comparison).
If such a policy restriction fails, the master falls back to transmitting its own credentials.
**Validate configuration** will indicate whether these calls are likely to work before actually running a build.

Note that if agents are themselves running in EC2, you must use tools to block them from having any default AWS credentials.
For example, if the Jenkins system is running in EKS, you could try [kube2iam](https://github.com/jtblin/kube2iam).

### Permissions for the master

The Jenkins master will need permissions for at least these API calls, scoped to the log group name:

* `FilterLogEvents`
* `DescribeLogStreams`
* `CreateLogStream`
* `AssumeRole` (where applicable)
* `GetFederationToken` (where applicable)
* `PutLogEvents`
* `GetLogEvents`

### Permissions for the agent

Assuming either `AssumeRole` or `GetFederationToken` succeeds,
the agent will be given these permissions,
scoped to particular log group and stream names:

* `PutLogEvents`
* `GetLogEvents`

### `withCredentials`

The `withCredentials` step works to mask secrets accidentally printed to the console log, even from agents.
The secret will be present in the agent JVM (as always)
and the filtering happens in the agent JVM before transmission to CloudWatch Logs.

# Known issues

Temporary credentials are issued with a default expiration time (such as one hour)
and are not currently refreshed after that expiration,
so there may be a loss of content for individual steps running longer than that.

Only `AssumeRule` starting with temporary security credentials has been tested for purposes of policy restriction.
`GetFederationToken` has not been tested.

The retrieval of log content from CloudWatch Logs for display inside Jenkins is not well optimized.
API requests made from the master filter down to the level of log stream group, log stream name pattern,
build number, and (where applicable) step identifier.
However due to the use of bytestream-based cursors in Jenkins (core and Blue Ocean),
the entire build may be downloaded even if the console display is truncated;
and incremental display of a running build will perform multiple downloads.

Scalability to large numbers of builds, gigantic build logs, or extremely long lines of text has not been evaluated.

**Validate configuration** does not check availability of all master permissions.

Job names involving unusual characters may not work.

# Changelog

## 0.1 (2018-11-20)

Initial release. Treat as alpha quality.
